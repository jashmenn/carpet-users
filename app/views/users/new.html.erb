<%= fb_connect_javascript_tag %>

<div class="span-12 account-left">
<div class="pic">
pic
</div>
<div class="login">
Already have an account? Log in here
<%= render :partial => "user_sessions/form" %>
</div>

</div>
<div class="span-12 account last">
  <div class="inside">
<h1>Log in with Facebook</h1>

<div class="fb_connect_button">
<%#= image_tag "fb_connect.png" %>
<%# <fb:login-button onlogin="alert('logged in!');" length='long'></fb:login-button> %>
<%# <fb:login-button onlogin="alert('hello');"></fb:login-button> %>
<fb:login-button onlogin="window.location.reload(true); "length='long'></fb:login-button>
<%# <fb:login-button v="2" size="large" onlogin="window.location.reload(true);">Login with Facebook</fb:login-button> %>
</div>

<hr />
or...

<h4>Register a new Account</h4>
<% form_for @user, :url => account_path do |f| %>
  <%= f.error_messages %>
  <%= render :partial => "form", :object => f %>
  <%= f.submit "Register" %>
<% end %>

  </div>
</div>

<script type="text/javascript"> 

  function update_user_box() { 
    var api = FB.Facebook.apiClient;
    var s = api.get_session();
    <%# alert("Current session id is " + api.get_session().session_key); %>
    alert(s.name); 
    $.post('<%= user_session_path %>', { 
      user_session: { 
        facebook_uid: s.uid, 
        facebook_session: s.session_key 
      }
     });
    <%# alert("hello from user box"); %>
  }

   FB_RequireFeatures(["Connect"], function() {
   FB.init("<%= Rails.application.config.fb_api_key %>", "/xd_receiver.html", {"ifUserConnected" : update_user_box})
   FB.ensureInit(function() {
            FB.Connect.get_status().waitUntilReady( function( status ) {
                var api = FB.Facebook.apiClient;

                switch ( status ) {
                case FB.ConnectState.connected:
                loggedIn = true;
                // alert("Current user id is " + api.get_session().uid);
                // alert("Current user id is " + api.get_session().session_key);
                break;
                case FB.ConnectState.appNotAuthorized:
                  // alert("not auth");
                case FB.ConnectState.userNotLoggedIn:
                //   alert("no logged");
                // alert("no connected");
                FB.Connect.requireSession();
                loggedIn = false;
                }
                });
            });
  });
</script> 
